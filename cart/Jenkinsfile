pipeline {
    agent any
    environment {
        
        ecr_reg_address = "421320058418.dkr.ecr.us-west-2.amazonaws.com"
        repo = "ankur-robot-shop"
        
    }

    stages {
        stage('Git Clone') {
            steps {
                git 'https://github.com/ankur-kesari/robot-shop.git'
                }
        }
        
        stage('Docker Build'){
            steps{
          
                sh  'docker build -t cart/robot-shop cart/'
                sh 'docker tag cart/robot-shop ${ecr_reg_address}/${repo}:cart-build'
                 }
        }
        stage('ECR Authentication'){
                steps{
                 sh 'sudo chmod 777 /var/run/docker.sock'   //#error resolve for linux slave machine
                 sh 'sudo aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 421320058418.dkr.ecr.us-west-2.amazonaws.com'
                  }   // added sudo
        }
        
        stage('Docker Push'){
                 steps{
                     sh 'docker push ${ecr_reg_address}/${repo}:cart-build'
            
                    }
        }
    }
}
